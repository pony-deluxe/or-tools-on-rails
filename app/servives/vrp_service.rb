class VRPService
  attr_accessor :data, :manager, :routing, :distance_callback, :transit_callback_index, :dimension_name, :solution
  EXAMPLE_DISTANCE_MATRIX = [
    [0, 548, 776, 696, 582, 274, 502, 194, 308, 194, 536, 502, 388, 354, 468, 776, 662],
    [548, 0, 684, 308, 194, 502, 730, 354, 696, 742, 1084, 594, 480, 674, 1016, 868, 1210],
    [776, 684, 0, 992, 878, 502, 274, 810, 468, 742, 400, 1278, 1164, 1130, 788, 1552, 754],
    [696, 308, 992, 0, 114, 650, 878, 502, 844, 890, 1232, 514, 628, 822, 1164, 560, 1358],
    [582, 194, 878, 114, 0, 536, 764, 388, 730, 776, 1118, 400, 514, 708, 1050, 674, 1244],
    [274, 502, 502, 650, 536, 0, 228, 308, 194, 240, 582, 776, 662, 628, 514, 1050, 708],
    [502, 730, 274, 878, 764, 228, 0, 536, 194, 468, 354, 1004, 890, 856, 514, 1278, 480],
    [194, 354, 810, 502, 388, 308, 536, 0, 342, 388, 730, 468, 354, 320, 662, 742, 856],
    [308, 696, 468, 844, 730, 194, 194, 342, 0, 274, 388, 810, 696, 662, 320, 1084, 514],
    [194, 742, 742, 890, 776, 240, 468, 388, 274, 0, 342, 536, 422, 388, 274, 810, 468],
    [536, 1084, 400, 1232, 1118, 582, 354, 730, 388, 342, 0, 878, 764, 730, 388, 1152, 354],
    [502, 594, 1278, 514, 400, 776, 1004, 468, 810, 536, 878, 0, 114, 308, 650, 274, 844],
    [388, 480, 1164, 628, 514, 662, 890, 354, 696, 422, 764, 114, 0, 194, 536, 388, 730],
    [354, 674, 1130, 822, 708, 628, 856, 320, 662, 388, 730, 308, 194, 0, 342, 422, 536],
    [468, 1016, 788, 1164, 1050, 514, 514, 662, 320, 274, 388, 650, 536, 342, 0, 764, 194],
    [776, 868, 1552, 560, 674, 1050, 1278, 742, 1084, 810, 1152, 274, 388, 422, 764, 0, 798],
    [662, 1210, 754, 1358, 1244, 708, 480, 856, 514, 468, 354, 844, 730, 536, 194, 798, 0]
  ]

  PONY_DISTANCE_MATRIX = [[0.0, 1.9483814059317044, 1.8109708760808965, 2.9899445742732373, 2.244815464676043, 1.560937080979124, 1.9817891736559048, 2.5531425195455903, 2.825225930858356, 0.737485838383235, 1.6521652887600515, 2.02121243366974, 0.3697012124818481, 1.68299929725156, 4.085332596662298, 1.1265650324608905, 2.7495876940049335, 0.44375377478856054, 1.3600355257042673, 3.664566364568008, 0.9707234620296571, 3.037235920263179, 0.21714489281652902, 0.3959952666153182, 4.205714748029509, 5.0438244837533475], [1.9483814059317046, 0.0, 3.169737199738225, 3.8995534428050744, 0.9473017258944825, 1.149563589052157, 1.0110629733092442, 1.1710440402471043, 2.626092746132384, 1.5310282995264046, 3.30060763828385, 1.1973969743782982, 1.9581662430450322, 3.047060240777862, 2.375973093743112, 0.8727964714217697, 2.7776192579637686, 2.314509804762249, 2.1793210492153428, 3.002396699993199, 1.4031111630320638, 2.9311204163352387, 2.081161118919993, 2.019138707573815, 4.693561911593933, 4.6022454486994775], [1.8109708760808965, 3.1697371997382247, 0.0, 1.2857883845245572, 2.8856703168983295, 2.147752494211216, 2.567942641748565, 3.102203122429508, 2.202947957496203, 2.5194707519790334, 0.5589603287741782, 2.4647241135149245, 2.160215995275173, 0.1316383417907453, 4.5740084607224, 2.345725446926465, 1.9415395734483591, 1.430577768645083, 1.0375612134503496, 3.1737086080927703, 1.7703095107232536, 2.2327572092569534, 1.597804172433541, 1.4460994111264438, 2.6353806452872184, 4.093682376354079], [2.9899445742732373, 3.8995534428050744, 1.2857883845245572, 0.0, 3.3242091322509677, 2.755477760311068, 3.0483439977555102, 3.4397389241557073, 1.9265854652827763, 3.6378269606956146, 1.7763079600119807, 2.8878205845087552, 3.356178243049118, 1.3839543621430554, 4.67122312249677, 3.210860874838636, 1.6040227154345321, 2.664331480703638, 1.8021584395472778, 2.742158070779779, 2.6305538142026395, 1.7738591325203668, 2.791302134220167, 2.5979939541243033, 1.3733800456342424, 3.1804306330849315], [2.244815464676043, 0.9473017258944825, 2.8856703168983295, 3.3242091322509677, 0.0, 0.7770620476183878, 0.32006638461409276, 0.31198168899784184, 1.7721553484444657, 2.1206132948838197, 3.1696197996030984, 0.44004422408016475, 2.4018054405840688, 2.7831361868515114, 1.8504895295272052, 1.1787138614583483, 1.9785377471897787, 2.4794086721668895, 1.8501879825273753, 2.056250908823468, 1.355940807619233, 2.07848984275989, 2.293860166676381, 2.140332405036838, 3.9202789497090285, 3.657693742300812], [1.5609370809791243, 1.149563589052157, 2.147752494211216, 2.755477760311068, 0.7770620476183879, 0.0, 0.4638404546179657, 1.0534511647232776, 1.6113898495866277, 1.6329372746846116, 2.3992385618556913, 0.46154559416848484, 1.7857359096309653, 2.0378347375924726, 2.6084154362814496, 0.7157126194632623, 1.6966171669911936, 1.7358594213348255, 1.1124224772908682, 2.2432369254047346, 0.6078579728216855, 1.89961044240194, 1.5724203788733742, 1.3951681541922893, 3.568664259870383, 3.7672327598340387], [1.9817891736559048, 1.0110629733092442, 2.567942641748565, 3.0483439977555102, 0.32006638461409276, 0.46384045461796564, 0.0, 0.5906619329429561, 1.6163427173936482, 1.9376971896787478, 2.8499184947295895, 0.18759536279007905, 2.1688201497725874, 2.464373397437544, 2.146245654421606, 0.9798064559680516, 1.7832908143390538, 2.18880320314661, 1.5315400528255743, 2.0502504353350206, 1.0596237937941257, 1.9221803567515574, 2.013905616217664, 1.8482931634273982, 3.7171545479265506, 3.6325006729217226], [2.553142519545591, 1.1710440402471043, 3.102203122429508, 3.4397389241557073, 0.31198168899784184, 1.0534511647232776, 0.5906619329429561, 0.0, 1.7564416259593747, 2.4286126849649783, 3.4173792181217815, 0.6418353489968953, 2.713736221828533, 3.0061680446426218, 1.5555891567890272, 1.4902391755080024, 2.001151159389891, 2.7769957709039224, 2.076918231027989, 1.8890299965801824, 1.6490044375079227, 2.0554435995894607, 2.5968253257781493, 2.436863071520264, 3.930081766816495, 3.4896071840465686], [2.825225930858356, 2.626092746132384, 2.202947957496203, 1.9265854652827763, 1.7721553484444657, 1.6113898495866277, 1.6163427173936482, 1.7564416259593747, 0.0, 3.151113777265778, 2.715384321973734, 1.429146400310236, 3.150123652418262, 2.1745391836941947, 2.764581841351855, 2.31465064988856, 0.32282384588814467, 2.7702196992729906, 1.570494779759791, 0.9731151774723441, 1.9480746973962266, 0.3069905253844047, 2.728410931155, 2.4938564652602393, 2.175358684224234, 2.2230158649167113], [0.737485838383235, 1.5310282995264046, 2.5194707519790334, 3.6378269606956146, 2.1206132948838197, 1.6329372746846114, 1.9376971896787478, 2.4286126849649783, 3.151113777265778, 0.0, 2.3895265684498184, 2.041046988431413, 0.5131183554320644, 2.3890408585566947, 3.8601542947361156, 0.9579291861354033, 3.1449798942593086, 1.1784904902989455, 1.8921707672731656, 3.872446431728087, 1.2081262120141136, 3.4048338203815094, 0.9526625255656773, 1.073372302091279, 4.77867074957352, 5.36173964573897], [1.6521652887600515, 3.30060763828385, 0.5589603287741782, 1.7763079600119807, 3.169619799603098, 2.3992385618556913, 2.8499184947295895, 3.4173792181217815, 2.715384321973734, 2.3895265684498184, 0.0, 2.7761156682143935, 1.9540439300878534, 0.5466082417773604, 4.936582623185485, 2.43617494448652, 2.4713809747879267, 1.2164282248203875, 1.3569547731811937, 3.688477818137922, 1.9132940782887922, 2.7687808024926652, 1.4371658452847373, 1.3627300750887736, 3.1465313857819335, 4.651535729652669], [2.02121243366974, 1.1973969743782982, 2.4647241135149245, 2.8878205845087552, 0.44004422408016475, 0.46154559416848484, 0.18759536279007905, 0.6418353489968953, 1.429146400310236, 2.041046988431413, 2.7761156682143935, 0.0, 2.2348747424722335, 2.3665873309958685, 2.177141772641966, 1.087833054366633, 1.5967759636631706, 2.19251150518462, 1.4358689583018056, 1.8922802795809126, 1.0679587332439449, 1.7348073479730197, 2.0334446878468255, 1.8522874914657057, 3.5323898353956493, 3.464563047547119], [0.3697012124818481, 1.9581662430450322, 2.160215995275173, 3.356178243049118, 2.4018054405840688, 1.7857359096309653, 2.1688201497725874, 2.713736221828533, 3.150123652418262, 0.5131183554320644, 1.9540439300878534, 2.2348747424722335, 0.0, 2.0343918401448926, 4.210061721881193, 1.2304787680978466, 3.0914837425802886, 0.7433174065456576, 1.721498444366869, 3.958654336935306, 1.2372386182382553, 3.3736774099005644, 0.566596516656845, 0.7656827179613261, 4.575206463472071, 5.372727892755538], [1.68299929725156, 3.047060240777862, 0.1316383417907453, 1.3839543621430554, 2.7831361868515114, 2.0378347375924726, 2.464373397437544, 3.0061680446426218, 2.1745391836941947, 2.3890408585566947, 0.5466082417773604, 2.3665873309958685, 2.0343918401448926, 0.0, 4.490490499134243, 2.2186963607076002, 1.925592323746371, 1.3087135804549417, 0.9329496349512661, 3.147447626825439, 1.6459020935778637, 2.2223039653371517, 1.4706980325094536, 1.3157351661445016, 2.71906150228171, 4.114769760310575], [4.085332596662299, 2.375973093743112, 4.5740084607224, 4.67122312249677, 1.8504895295272052, 2.6084154362814496, 2.146245654421606, 1.5555891567890272, 2.764581841351855, 3.8601542947361156, 4.936582623185485, 2.177141772641966, 4.210061721881193, 4.490490499134243, 0.0, 2.9815051460324833, 3.0801617689820104, 4.329695127130341, 3.581118815186902, 2.281480858154851, 3.2036810373051683, 2.988223517287459, 4.143218437683432, 3.9902407328321368, 4.7975803804723824, 3.575167370787774], [1.1265650324608905, 0.8727964714217697, 2.345725446926465, 3.2108608748386365, 1.1787138614583483, 0.7157126194632623, 0.9798064559680516, 1.4902391755080024, 2.31465064988856, 0.9579291861354033, 2.43617494448652, 1.087833054366633, 1.2304787680978466, 2.2186963607076002, 2.981505146032483, 0.0, 2.369643409009828, 1.4552632808299633, 1.419329382977278, 2.951352583984226, 0.5894122664083569, 2.5943039742946623, 1.2304213111468814, 1.149188334228062, 4.170926896180873, 4.482941114906186], [2.7495876940049335, 2.7776192579637686, 1.9415395734483591, 1.6040227154345321, 1.9785377471897787, 1.6966171669911936, 1.7832908143390538, 2.001151159389891, 0.32282384588814467, 3.1449798942593086, 2.4713809747879267, 1.5967759636631706, 3.0914837425802886, 1.925592323746371, 3.0801617689820104, 2.369643409009828, 0.0, 2.645816599410642, 1.4308814953499651, 1.243021398275227, 1.9377628701850456, 0.3067242932247883, 2.6313128368200642, 2.39479682626144, 1.9417525755710807, 2.3114172637018164], [0.44375377478856054, 2.314509804762249, 1.430577768645083, 2.664331480703638, 2.47940867216689, 1.7358594213348255, 2.18880320314661, 2.7769957709039224, 2.7702196992729906, 1.1784904902989455, 1.2164282248203875, 2.19251150518462, 0.7433174065456576, 1.3087135804549417, 4.329695127130341, 1.4552632808299633, 2.645816599410642, 0.0, 1.215030206337928, 3.6694798471645855, 1.129626085801433, 2.9463060758091877, 0.24419228861568718, 0.3407507034195067, 3.9361932996111864, 4.957216330152214], [1.3600355257042673, 2.1793210492153428, 1.0375612134503496, 1.802158439547278, 1.850187982527375, 1.112422477290868, 1.5315400528255743, 2.0769182310279892, 1.570494779759791, 1.8921707672731656, 1.3569547731811937, 1.4358689583018054, 1.721498444366869, 0.9329496349512661, 3.581118815186902, 1.419329382977278, 1.4308814953499651, 1.215030206337928, 0.0, 2.5042909864042717, 0.8322130713288634, 1.7322844270948192, 1.2160708276738204, 0.9813025225104451, 2.8867560516984527, 3.742296037919299], [3.664566364568008, 3.002396699993199, 3.1737086080927703, 2.7421580707797792, 2.056250908823468, 2.2432369254047346, 2.0502504353350206, 1.8890299965801824, 0.9731151774723441, 3.872446431728087, 3.688477818137922, 1.8922802795809126, 3.958654336935306, 3.147447626825439, 2.281480858154851, 2.951352583984226, 1.243021398275227, 3.669479847164586, 2.5042909864042717, 0.0, 2.722424469197558, 0.9872406713426841, 3.597218829806446, 3.3694206985643933, 2.5498282788757973, 1.6030051916238306], [0.9707234620296571, 1.4031111630320638, 1.7703095107232536, 2.6305538142026395, 1.355940807619233, 0.6078579728216854, 1.0596237937941257, 1.6490044375079227, 1.9480746973962266, 1.2081262120141136, 1.9132940782887924, 1.0679587332439449, 1.2372386182382553, 1.6459020935778634, 3.2036810373051683, 0.5894122664083569, 1.9377628701850456, 1.129626085801433, 0.8322130713288634, 2.722424469197558, 0.0, 2.19705827676541, 0.9658452229527722, 0.7889300721792849, 3.6429873469267138, 4.166581669866676], [3.037235920263179, 2.9311204163352382, 2.2327572092569534, 1.7738591325203668, 2.07848984275989, 1.89961044240194, 1.9221803567515574, 2.0554435995894607, 0.3069905253844047, 3.4048338203815094, 2.7687808024926652, 1.7348073479730197, 3.3736774099005644, 2.2223039653371517, 2.988223517287459, 2.5943039742946623, 0.3067242932247883, 2.9463060758091877, 1.7322844270948192, 0.9872406713426841, 2.19705827676541, 0.0, 2.9252728398226613, 2.6889539939458627, 1.8850202399033054, 2.012298024457881], [0.21714489281652902, 2.081161118919993, 1.597804172433541, 2.791302134220167, 2.293860166676381, 1.5724203788733742, 2.013905616217664, 2.5968253257781493, 2.728410931155, 0.9526625255656773, 1.4371658452847373, 2.0334446878468255, 0.566596516656845, 1.4706980325094536, 4.143218437683432, 1.2304213111468814, 2.6313128368200642, 0.24419228861568718, 1.2160708276738204, 3.597218829806446, 0.9658452229527722, 2.9252728398226613, 0.0, 0.23652542068428054, 4.025998510994712, 4.936852660317875], [0.3959952666153182, 2.019138707573815, 1.4460994111264438, 2.5979939541243033, 2.140332405036838, 1.3951681541922891, 1.8482931634273985, 2.436863071520264, 2.4938564652602393, 1.073372302091279, 1.3627300750887736, 1.8522874914657057, 0.7656827179613261, 1.3157351661445016, 3.990240732832136, 1.1491883342280622, 2.39479682626144, 0.34075070341950664, 0.9813025225104451, 3.3694206985643933, 0.7889300721792849, 2.6889539939458627, 0.23652542068428054, 0.0, 3.810204517463202, 4.700692281100001], [4.205714748029509, 4.693561911593933, 2.6353806452872184, 1.3733800456342424, 3.9202789497090285, 3.568664259870383, 3.7171545479265506, 3.930081766816495, 2.175358684224234, 4.77867074957352, 3.1465313857819335, 3.5323898353956493, 4.575206463472071, 2.71906150228171, 4.7975803804723824, 4.170926896180873, 1.9417525755710807, 3.9361932996111864, 2.8867560516984527, 2.5498282788757973, 3.6429873469267138, 1.8850202399033054, 4.025998510994712, 3.810204517463202, 0.0, 2.2426897009280107], [5.0438244837533475, 4.6022454486994775, 4.093682376354079, 3.1804306330849315, 3.657693742300812, 3.7672327598340387, 3.6325006729217226, 3.4896071840465686, 2.2230158649167113, 5.36173964573897, 4.651535729652669, 3.464563047547119, 5.372727892755538, 4.114769760310575, 3.575167370787774, 4.482941114906186, 2.3114172637018164, 4.957216330152214, 3.742296037919299, 1.6030051916238306, 4.166581669866676, 2.012298024457881, 4.936852660317875, 4.700692281100001, 2.2426897009280107, 0.0]]
  def initialize
    @data = {}
    data[:distance_matrix] = PONY_DISTANCE_MATRIX
    data[:num_vehicles] = 2
    data[:depot] = 0

    # define the distance callback
    @manager = ORTools::RoutingIndexManager.new(data[:distance_matrix].length, data[:num_vehicles], data[:depot])
    @routing = ORTools::RoutingModel.new(manager)
    @distance_callback = lambda do |from_index, to_index|
      from_node = manager.index_to_node(from_index)
      to_node = manager.index_to_node(to_index)
      data[:distance_matrix][from_node][to_node]
    end
    @transit_callback_index = routing.register_transit_callback(distance_callback)
    routing.set_arc_cost_evaluator_of_all_vehicles(transit_callback_index)

    # add a distance dimension
    @dimension_name = "Distance"
    routing.add_dimension(transit_callback_index, 0, 3000, true, dimension_name)
    distance_dimension = routing.mutable_dimension(dimension_name)
    distance_dimension.global_span_cost_coefficient = 100

    # run the solver
    @solution = routing.solve(first_solution_strategy: :path_cheapest_arc)
  end


  # print the solution
  def print_solution
    max_route_distance = 5
    data[:num_vehicles].times do |vehicle_id|
      index = routing.start(vehicle_id)
      plan_output = String.new("Route for vehicle #{vehicle_id}:\n")
      route_distance = 0
      while !routing.end?(index)
        plan_output += " #{manager.index_to_node(index)} -> "
        previous_index = index
        index = solution.value(routing.next_var(index))
        route_distance += routing.arc_cost_for_vehicle(previous_index, index, vehicle_id)
      end
      plan_output += "#{manager.index_to_node(index)}\n"
      plan_output += "Distance of the route: #{route_distance}m\n\n"
      puts plan_output
      max_route_distance = [route_distance, max_route_distance].max
    end
    puts "Maximum of the route distances: #{max_route_distance}m"
  end
end
